services:
  # 1. The Generator (Run this manually or via profile to update config)
  # It builds the custom image with MIBs, generates snmp.yml, and exits.
  snmp-generator:
    build: ./generator
    container_name: snmp-generator
    env_file:
      - .env
    environment:
      SNMP_USER: ${SNMP_USER}
      SNMP_AUTH_PASS: ${SNMP_AUTH_PASS}
      SNMP_PRIV_PASS: ${SNMP_PRIV_PASS}

    volumes:
      # Mount the current directory so the generated file appears on your host
      - ./snmp_exporter/:/output/

  # 2. The Exporter (The active listener)
  snmp-exporter:
    image: prom/snmp-exporter:v0.25.0
    container_name: snmp-exporter
    restart: always
    ports:
      - "9116:9116"
      - "161:161/udp"
    volumes:
      # Mount the file generated by the service above
      - ./snmp_exporter/nach:/etc/snmp_exporter
    depends_on:
      - snmp-generator

  # 3. Prometheus (The collector)
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    restart: always
    ports:
      - "9190:9090"
    volumes:
      - ./prometheus:/etc/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
