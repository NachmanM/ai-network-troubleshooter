services:
  # 1. The Generator (Run this manually or via profile to update config)
  # It builds the custom image with MIBs, generates snmp.yml, and exits.
  snmp-generator:
    build: ./generator
    container_name: snmp-generator
    env_file:
      - .env
    volumes:
      # Mount the current directory so the generated file appears on your host
      - ./snmp_exporter:/output

  # 2. The Exporter (The active listener)
  snmp-exporter:
    image: prom/snmp-exporter
    container_name: snmp-exporter
    restart: always
    ports:
      - "9116:9116"
    volumes:
      # Mount the file generated by the service above
      - ./snmp_exporter/snmp.yml:/etc/snmp_exporter/snmp.yml
    depends_on:
      - snmp-generator

  # 3. Prometheus (The collector)
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    restart: always
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
